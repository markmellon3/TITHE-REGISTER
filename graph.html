<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tithe Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    margin:0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #1f1f2e;
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
}
h2, h3 {
    margin-bottom: 10px;
    color: #f0f0f0;
}
.chart-card, .table-card {
    background: #2a2a3d;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    width: 95%;
    max-width: 900px;
    margin-bottom: 30px;
}
canvas {
    width: 100%;
    height: 400px;
}
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}
table th, table td {
    padding: 12px 15px;
    text-align: left;
}
table th {
    background: #3c3c55;
    font-weight: 600;
    border-bottom: 2px solid #555;
}
table td {
    background: #333355;
    border-bottom: 1px solid #444;
}
table tr:hover td {
    background: #444466;
}
@media(max-width:600px){
    table th, table td { font-size: 14px; padding: 8px;}
}
</style>
</head>

<body>

<h2>Tithe Dashboard</h2>

<div class="chart-card">
    <h3>Daily Tithe Collected</h3>
    <canvas id="dailyChart"></canvas>
</div>

<div class="chart-card">
    <h3>Weekly Tithe Collected</h3>
    <canvas id="weeklyChart"></canvas>
</div>

<div class="chart-card">
    <h3>Monthly Tithe Collected</h3>
    <canvas id="monthlyChart"></canvas>
</div>

<div class="chart-card">
    <h3>Yearly Tithe Collected</h3>
    <canvas id="yearlyChart"></canvas>
</div>

<div class="table-card">
    <h3>People Tithe History</h3>
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Amount (UGX)</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody id="peopleTable"></tbody>
    </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyAOlGmQUZ6uh7_HmmgERBfueWwhZP25g5o",
    authDomain: "register-d9ef9.firebaseapp.com",
    databaseURL: "https://register-d9ef9-default-rtdb.firebaseio.com/",
    projectId: "register-d9ef9",
    storageBucket: "register-d9ef9.appspot.com",
    messagingSenderId: "710136418226",
    appId: "1:710136418226:web:19b5ba39d279be23ad5eab"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const peopleTable = document.getElementById("peopleTable");

/* ===== DATE PARSER (DD/MM/YYYY) ===== */
function parseDateDMY(dateStr) {
    if (!dateStr) return null;
    const parts = dateStr.split("/");
    if (parts.length !== 3) return null;
    return new Date(parts[2], parts[1] - 1, parts[0]);
}

/* ===== CREATE BAR CHART ===== */
function createBarChart(ctx, label) {
    return new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label,
                data: [],
                backgroundColor: "rgba(75,192,192,0.7)",
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { labels: { color: "#fff" } },
                tooltip: {
                    backgroundColor: "#333355",
                    titleColor: "#fff",
                    bodyColor: "#fff"
                }
            },
            scales: {
                x: { ticks: { color: "#fff" } },
                y: { ticks: { color: "#fff" } }
            }
        }
    });
}

/* ===== INIT CHARTS ===== */
const dailyChart = createBarChart(
    document.getElementById("dailyChart").getContext("2d"),
    "Daily Tithe (UGX)"
);

const weeklyChart = createBarChart(
    document.getElementById("weeklyChart").getContext("2d"),
    "Weekly Tithe (UGX)"
);

const monthlyChart = createBarChart(
    document.getElementById("monthlyChart").getContext("2d"),
    "Monthly Tithe (UGX)"
);

const yearlyChart = createBarChart(
    document.getElementById("yearlyChart").getContext("2d"),
    "Yearly Tithe (UGX)"
);

/* ===== REAL-TIME FIREBASE DATA ===== */
onValue(ref(db, "people"), snapshot => {

    let dailyMap = {};
    let weeklyMap = {};
    let monthlyMap = {};
    let yearlyMap = {};
    let peopleArray = [];

    snapshot.forEach(personSnap => {
        const person = personSnap.val();
        if (!person.titheHistory) return;

        Object.values(person.titheHistory).forEach(entry => {
            const amount = Number(entry.amount) || 0;
            const date = parseDateDMY(entry.date);
            if (!date) return;

            peopleArray.push({
                name: person.name,
                amt: amount,
                dateStr: entry.date
            });

            /* DAILY */
            dailyMap[entry.date] = (dailyMap[entry.date] || 0) + amount;

            /* WEEKLY (Sunday start) */
            const weekStart = new Date(date);
            weekStart.setDate(date.getDate() - date.getDay());
            const weekKey = weekStart.toISOString().slice(0, 10);
            weeklyMap[weekKey] = (weeklyMap[weekKey] || 0) + amount;

            /* MONTHLY */
            const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}`;
            monthlyMap[monthKey] = (monthlyMap[monthKey] || 0) + amount;

            /* YEARLY */
            const yearKey = date.getFullYear();
            yearlyMap[yearKey] = (yearlyMap[yearKey] || 0) + amount;
        });
    });

    /* ===== PEOPLE TABLE ===== */
    peopleArray.sort((a, b) => a.name.localeCompare(b.name));
    peopleTable.innerHTML = "";
    peopleArray.forEach(p => {
        peopleTable.innerHTML += `
            <tr>
                <td>${p.name}</td>
                <td>${p.amt.toLocaleString()}</td>
                <td>${p.dateStr}</td>
            </tr>
        `;
    });

    /* ===== UPDATE CHARTS ===== */
    function updateChart(chart, map) {
        const labels = Object.keys(map).sort((a, b) => new Date(a) - new Date(b));
        chart.data.labels = labels;
        chart.data.datasets[0].data = labels.map(l => map[l]);
        chart.update();
    }

    updateChart(dailyChart, dailyMap);
    updateChart(weeklyChart, weeklyMap);
    updateChart(monthlyChart, monthlyMap);
    updateChart(yearlyChart, yearlyMap);
});
</script>

</body>
</html>
